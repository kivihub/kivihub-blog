### 一、ES索引分片设置原则

> 存储的数据如果是持续增长的，需要周期建索引进行水平拆分（按小时，按日，按月等），来保证以下的分片原则。

1）副本分片用于保证安全，至少设置为1。副本约多，越影响写入性能。

2）分片总数（主分片 + 副本分片）最好是集群节点数量的倍数，保证可以均匀分配，避免数据倾斜。

3）每个分片大小最好处于10G-65G间。

4）单数据节点上，每GB堆内存不能超过20个分片。

### 二、线上实战

假设我目前有个日志存储的场景如下：

![image-20210519163138634](../../src/main/resources/picture/image-20210519163138634.png)

>  ES集群信息：
>
> * ES有9个数据节点，单数据节点规格为16核64G 7000GB
>
> * 含协调节点和主节点

##### 1）确认索引创建周期

从管理维度上考虑，选择“按日”新建索引，格式类似“my_log_yyyy-MM-dd”

##### 2）确认索引的数据量

由于以上应用场景，可根据MQ的Broker监控获知日消息数和日流量大小。

* 日均日志条数：约8亿—10亿间。
* 日均日志大小：约4.5T

NOTE：另外，可计算出单条日志平均大小约5KB。

##### 3）计算索引分片数

* 根据每GB堆内存不超过20个分片，假设当前堆内存设置为32G
  * 单节点最大支持：32 * 20 = 640分片
  * 按单分片50G，则磁盘相应大小为640 * 50G  = 31.25T，考虑80%负载，磁盘需要39T
  * 以上结论可知当，单分片为50G，磁盘空间小于39T时，肯定符合每GB堆内存不超过20个分片

* 按单分片为50GB，则每日索引不含副本共需要4.5T/50G = 92个分片
* 索引副本数设置为1，则每日索引含副本共需要92*2 = 184个分片
* 由以上得出的分片数，再考虑分片需要为数据节点的整数倍，最终设置日索引分片为90，副本为1

##### 4）推算索引保留时间

粗略估算如下：

* 饱和存储：7000G * 9个数据节点 / 4.5T = 14天
* 80%存储：14 * 80% = 11.2天

### # 参考

1. https://www.elastic.co/guide/en/elasticsearch/reference/current/size-your-shards.html