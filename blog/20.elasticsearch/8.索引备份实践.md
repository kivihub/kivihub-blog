### 一、备份目标

- 备份线上系统日志，到另一个ES。以备后期计算TPS，单量等数据

- 迁移时间范围：2021-05-30 至 2021-06-25

- 提高reindex速度，减小存储压力优化措施：

  - 备份索引不设置副本

  - 只迁移spanId为end的日志结点

  - 迁移部分字段，过滤extend_1,extend_2,extend_3等字段，source大小变为1/10

### 二、备份过程

> 从源ES备份到目标ES，备份过程只在**目标es**操作。

#### 1）建立和源ES相同的索引

可通过模板或者Mapping创建。

```bash
$ POST _template/xxx_tpl
{
    "settings" : {
        "index" : {
            "number_of_replicas" : "0" # 副本修改为0，减少备份容量
        }
    },
    ...
}
```

#### 2）配置reindex.remote.whitelist

reindex.remote.whitelist为源ES地址。

#### 3）登陆目标ES，执行脚本

> 可执行多个索引迁移任务，多个reindex任务会并行执行，例如以10天为一个区间进行迁移；

参考：https://www.elastic.co/guide/en/elasticsearch/reference/6.8/docs-reindex.html

```bash
# wait_for_completion把任务设为异步任务，避免中断
$ POST _reindex?wait_for_completion=false
{
    "source": {
        "remote": {
            "host": "http://source ES:9200", # 源ES
            "username": "xxx",
            "password": "xxx"
        },
        "index": "xxx_2021.05.30",
        "_source": ["appCode", "traceId", ... ],  # 非全量迁移字段，减小存储压力和迁移速度
        "size": 10000,  # size字段取值参考下一节"reindex-size取值优化"
        "query": {	# 增加查询条件，非全量迁移document
            "match": {
                "spanId": "end"    
            }
        }
    },
    "dest": {
        "index": "xxx_2021.05.30",
        "op_type": "create"
    }
}
```

#### 4）查看跟踪任务

参考：https://www.elastic.co/guide/en/elasticsearch/reference/6.8/tasks.html

```bash
# 查看任务
$ GET _tasks/[taskID]
$ GET _tasks?detailed=true&actions=*reindex

# 取消任务
$ POST _tasks/[taskID]/_cancel
```

### 三、reindex-size取值优化

> size设置要合理，参考两个原则：
>
> 1）size不能大于10000；
>
> 2）size数量的Document的大小不能超过buffer。

```json
{
  "completed" : true,
  "task" : {
    "node" : "mxMIBxgNS3ek5URhsxmQkw",
    "id" : 2964624,
    "type" : "transport",
    "action" : "indices:data/write/reindex",
    "status" : {
      "total" : 0,
      "updated" : 0,
      "created" : 0,
      "deleted" : 0,
      "batches" : 0,
      "version_conflicts" : 0,
      "noops" : 0,
      "retries" : {
        "bulk" : 0,
        "search" : 0
      },
      "throttled_millis" : 0,
      "requests_per_second" : -1.0,
      "throttled_until_millis" : 0
    },
    "description" : """
reindex from [host=es-nlb-xxx.xxx.com port=9200 query={
  "match" : {
    "spanId" : "end"
  }
} username=xxx password=<<>>][xxx_2021.05.30] to [xxx_2021.05.30]
""",
    "start_time_in_millis" : 1624958356693,
    "running_time_in_nanos" : 778599920,
    "cancellable" : true,
    "headers" : { }
  },
  "error" : {
    "type" : "illegal_argument_exception",
    "reason" : "Remote responded with a chunk that was too large. Use a smaller batch size.",
    "caused_by" : {
      "type" : "content_too_long_exception",
      "reason" : "entity content is too long [118324742] for the configured buffer limit [104857600]"
    }
  }
}
```

### # 参考

1. https://www.elastic.co/guide/en/elasticsearch/reference/6.0/reindex-upgrade-remote.html
2. https://discuss.elastic.co/t/not-whitelisted-in-reindex-remote-whitelist/111070
3. [提高reindex效率](https://blog.csdn.net/laoyang360/article/details/81589459)