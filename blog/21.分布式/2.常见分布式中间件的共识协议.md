共识协议是分布式网络中各结点对数据达成一致的方法和策略。可参考[分布式网络及共识协议](./1.分布式网络及共识协议.md)

### 一、Zookeeper共识

ZK定位是分布式的协调框架，使用ZAB协议使ZK集群达到数据共识。ZK适合作一些元数据和配置存储，其吞吐率和容量都不适合分布式存储。

#### 0）ZAB之恢复

ZAB协议恢复，即触发Leader选举，促使集群恢复到一主多从的广播状态。具体有三种场景：

* 集群初次启动
* Leader重启
* Follower重启



// TODO用流程图方式画选举过程

#### 1）ZAB之广播

写操作统一由leader处理，然后通过2-phase方式原子广播给Follower，这保证了消息完全有序和因果有序。即便是Follower接收到写请求，也会转发给Leader。从图中可看出，ZK是一种primary-backup模式，leader会把命令的结果包装为提议广播给Follower，这保证了消息的幂等性。

ZK的集群结点数一般为3-7个，增加结点会增加读吞吐，但对写吞吐无益，适用于读多写少的场景。

![image-20210623233218060](../../src/main/resources/picture/image-20210623233218060.png)

#### 2）ZK数据同步策略

提议广播只要收到quorum的ack（包括leader自己在内）就会广播commit。CAP角度来看，其实现了最终一致性，而非强一致性。即如果客户端发起一个写请求，且leader返回成功后，只代表ZK集群的大数结点具备了该数据，此时如果另一个客户端在未及时同步的结点上发送读请求，则无法看到最新数据。但是ZK在使用时，Client大都基于事件监听机制去获取数据，最坏结果表现为数据更新出现延迟通知。

#### 3）关于分布式锁

zookeeper实现分布式锁时，有两种类型：

* 非公平锁：通过创建指定名称临时结点避免客户端宕0机，创建成功的客户端获得锁，失败的客户端监听该临时结点（大量客户端被唤醒去争强锁也被称为羊群效应）。
* 公平锁：通过创建有序的临时结点避免客户端宕机，序号最小的临时结点的客户端获得锁，其他客户端监听前一个零时结点，有序排队等待唤醒。

其中，可重入锁的重入的次数可以作为文件内容，随加锁和解锁进行更新；

这其中有个点需要指出，由于zookeeper并不是强一致性，客户端可能无法查到集群中最新写入的数据，但最终会达到一致。这并不影响分布式锁的实现，主要有以下原因：

* 客户端的写入是线性有序的；
* 客户端在不同时间看到的临时结点数量可能不一致，但是他们的顺序是可以保证的；
* 基于以上两点，客户端在create成功后，可以进行多次查询，只要查询到含自己锁的数据集合即可；然后增加前置结点的watcher。

### 二、Redis共识

1）Redis的存储结构



2）Redis数据同步策略

### 三、Elasticsearch共识

1）ES的存储结构

2）ES的数据同步策略

### 四、Kafka共识

Kafka依赖ZK对Kafka集群状态进行维护，例如主题的分区信息，消费者的offset等信息，即依赖ZK使Kafka对集群状态达成共识。

1）kafka的存储结构

2）kafka的同步策略

### # 参考

1. [ZAB协议 Paper](https://wenku.baidu.com/view/d6545edaad51f01dc281f133.html)  [译文](https://www.cnblogs.com/j-well/p/7061091.html)

2. [ZK Paper：Wait-free coordination for Internet-scale systems](https://www.usenix.org/legacy/event/atc10/tech/full_papers/Hunt.pdf)  [译文](https://iswade.github.io/translate/zookeeper/)

3. [图文翔实：实例详解ZooKeeper ZAB协议、分布式锁与领导选举](https://dbaplus.cn/news-141-1875-1.html)

4. [理解zookeeper选举机制](https://www.cnblogs.com/shuaiandjun/p/9383655.html)